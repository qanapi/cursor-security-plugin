---
description: Prevents unrestricted file upload and malicious file execution by validating content, enforcing limits, and storing safely
alwaysApply: true
---

# File Upload Security

## Vulnerability Description

Unrestricted file upload vulnerabilities occur when applications accept files from users without proper validation, storage, or access controls. Attackers upload malicious files (web shells, scripts, or malware) that may be executed by the server or downloaded by other users. Relying on file extension or client-provided MIME type is insufficient because both can be forged. Malicious files can lead to remote code execution, denial of service, or malware distribution.

## Anti-Patterns to Avoid

### Validating Only by File Extension

```
ext = get_extension(filename)
if (ext == "jpg" || ext == "png") {
  save(file)
}
```

### Trusting Client-Provided MIME Type

```
if (request.headers["Content-Type"] == "image/jpeg") {
  save(file)
}
```

### Storing Uploads in Webroot

```
path = "/var/www/html/uploads/" + filename
file.save(path)
```

### Using User-Provided Filenames

```
filename = request.files[0].original_filename
path = base_dir + "/" + filename
save(file, path)
```

### Serving Uploaded Files with Execution Permissions

```
response.headers["Content-Type"] = "image/jpeg"
return file_content
```

### No Size Limits

```
save(request.body)
```

### Executing or Including Uploaded Files

```
include(upload_path)
require(upload_path)
eval(file_content)
```

### Denylist of Extensions Only

```
blocked = [".php", ".exe", ".sh"]
if (blocked.includes(ext)) {
  reject()
}
save(file)
```

## Secure Patterns

### Validate File Type by Content (Magic Bytes)

```
signatures = {
  "image/jpeg": [0xFF, 0xD8, 0xFF],
  "image/png": [0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A],
  "application/pdf": [0x25, 0x50, 0x44, 0x46]
}
header = read_bytes(file, 0, 8)
detected_type = match_signature(header, signatures)
if (detected_type == null || !allowed_types.includes(detected_type)) {
  reject()
}
```

Inspect the file header (magic bytes) to determine type. Use an allowlist of permitted types. Never trust extension or Content-Type header alone.

### Enforce Size Limits

```
max_size = 5 * 1024 * 1024
if (file.size > max_size) {
  reject()
}
```

Enforce a maximum file size before processing. Reject oversized uploads to prevent resource exhaustion.

### Store Uploads Outside Webroot

```
upload_dir = "/var/app/storage/uploads"
path = join(upload_dir, random_filename())
save(file, path)
```

Store files in a directory not served directly by the web server. Serve files through a controlled endpoint that validates access and sets safe headers.

### Use Random Filenames

```
filename = generate_uuid() + "." + allowed_extension
path = join(base_dir, filename)
save(file, path)
```

Generate random, unpredictable filenames. Never use user-provided filenames. If extension is needed, derive it from validated content type, not user input.

### Set Content-Disposition: Attachment for Downloads

```
response.headers["Content-Disposition"] = "attachment; filename=\"" + safe_filename + "\""
response.headers["Content-Type"] = detected_mime_type
return file_content
```

Use attachment disposition to prevent inline execution in browsers. Use a safe, generated filename for the download.

### Never Execute Uploaded Files

```
path = join(upload_dir, random_filename())
save(file, path)
```

Treat all uploaded files as data. Do not include, require, exec, or pass them to interpreters. Store and serve only; never execute.

### Restrict Allowed MIME Types via Allowlist

```
allowed_types = ["image/jpeg", "image/png", "application/pdf"]
detected = detect_mime_from_content(file)
if (!allowed_types.includes(detected)) {
  reject()
}
```

Maintain a strict allowlist of MIME types. Validate against content, not client headers. Reject any type not on the list.

### Scan for Malware When Appropriate

```
if (malware_scanner.scan(file) != "clean") {
  reject()
}
save(file, path)
```

For high-risk contexts, integrate malware scanning before accepting the file. Quarantine or reject infected files.

## Standards Mapping

| Standard | ID |
|----------|-----|
| CWE | 434 – Unrestricted Upload of File with Dangerous Type |
| CWE | 436 – Interpretation Conflict |
